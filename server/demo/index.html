<!DOCTYPE html>
<html lang="en">

<head>
    <title></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

</head>

<body>
    <p>
        <video id='liveVideo' />
    </p>
    <p>
        <video src="" id="targetVideo" autoplay></video>
    </p>
    <input type="text" name="tbUser" value="" id="tbUsername" , placeholder="Please input username">
    <input type="text" name="tbpassword" value="" id="tbPassword" , placeholder="please input password">
    <script src="./js/socket.io.js"></script>
    <script src="./js/socket.io-stream.js"></script>
    <script src="./js/MediaStreamRecorder.js"></script>
    <script>
        const mediaConstraints = {
            audio: true,
            video: {
                mandatory: {
                    minWidth: 500, // Provide your own width, height and frame rate here
                    minHeight: 300,
                    minFrameRate: 30
                }
            }
        }
        let streamCb = null;

        function getLocalStream(isFront, callback) {
            streamCb = callback;
            navigator.mediaDevices.getUserMedia(mediaConstraints)
                .then(onMediaSuccess)
                .catch(onMediaError)
        }

        function onMediaSuccess(stream) {
            streamCb(stream);
            var mediaRecorder = new MediaStreamRecorder(stream);
            mediaRecorder.mimeType = 'video/webm';

            mediaRecorder.ondataavailable = function (blob) {
                let stream = ss.createStream()
                ss(socket).emit("upload", stream)
                ss.createBlobReadStream(blob).pipe(stream)
            };
            mediaRecorder.start(5000);
        }

        function onMediaError(e) {
            console.error('media error', e);
        }

        getLocalStream(true, (stream) => {
            let video = document.getElementById("liveVideo")
            video.src = window.URL.createObjectURL(stream)
        })

        var socket = io('/test');
        socket.on('connect', () => {
            socket.emit('login', {
                id: '705730534'
            })
        })

        socket.on('onSourceChange', () => {
            // document.getElementById("targetVideo").src = '/channel/playlist'
        })
    </script>
</body>

</html>